---
title: "Calculos correlación intraclásica censo"
author: "José Fernando Zea"
date: "21/2/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Cargamos los paquetes necesarios

```{r, warning=FALSE, message=FALSE}
library(samplesize4surveys)
library(dplyr)
```


# Ocupados

```{r, warning=FALSE, message=FALSE}
setwd("../output/4.UPM_Colapsadas_indicadores")
consulta_ocupac <- readRDS("consulta_ocupac.rds")
```

```{r}
dim(consulta_ocupac)
```


```{r}
consulta_ocupac <- consulta_ocupac %>% filter(PEA == 1 & !is.na(PEA))
```

```{r}
dim(consulta_ocupac)
```


Las variables a analizar son:


```{r}
var_desmpleo <-  c("Desocupados")
```






# Escenario original

```{r}
m_icc_varOcup <- matrix(,nrow = length(var_desmpleo), ncol = 3)
for(i in 1:length(var_desmpleo)){
  m_icc_varOcup[i,1] <- samplesize4surveys::ICC(dplyr::filter(consulta_ocupac, URBRUR == 1)[[var_desmpleo[i]]], 
                                        cl = dplyr::filter(consulta_ocupac, URBRUR == 1)$id_upm_inicial)$ICC
}

for(i in 1:length(var_desmpleo)){
  m_icc_varOcup[i,2] <- samplesize4surveys::ICC(dplyr::filter(consulta_ocupac, URBRUR == 2)[[var_desmpleo[i]]], cl = dplyr::filter(consulta_ocupac, URBRUR == 2)$id_upm_inicial)$ICC
}


for(i in 1:length(var_desmpleo)){
  m_icc_varOcup[i,3] <- samplesize4surveys::ICC(consulta_ocupac[[var_desmpleo[i]]], 
                                        cl = consulta_ocupac$id_upm_inicial)$ICC
}

colnames(m_icc_varOcup) <- c("Urbano", "Rural", "Nacional")
row.names(m_icc_varOcup) <- var_desmpleo


#df_deff_varOcup <- 1 + (as.matrix(m_icc_varOcup) * (10 - 1))

```



# Escenario con 50 viviendas

```{r}
m_icc50_varOcup <- matrix(,nrow = length(var_desmpleo), ncol = 3)
for(i in 1:length(var_desmpleo)){
  m_icc50_varOcup[i,1] <- samplesize4surveys::ICC(dplyr::filter(consulta_ocupac, URBRUR == 1)[[var_desmpleo[i]]], 
                                        cl = dplyr::filter(consulta_ocupac, URBRUR == 1)$id_upm100)$ICC
}

for(i in 1:length(var_desmpleo)){
  m_icc50_varOcup[i,2] <- samplesize4surveys::ICC(dplyr::filter(consulta_ocupac, URBRUR == 2)[[var_desmpleo[i]]], cl = dplyr::filter(consulta_ocupac, URBRUR == 2)$id_upm50)$ICC
}


for(i in 1:length(var_desmpleo)){
  m_icc50_varOcup[i,3] <- samplesize4surveys::ICC(consulta_ocupac[[var_desmpleo[i]]], 
                                        cl = consulta_ocupac$id_upm50)$ICC
}

colnames(m_icc50_varOcup) <- c("Urbano", "Rural", "Nacional")
row.names(m_icc50_varOcup) <- var_desmpleo
```



# Escenario con 100 viviendas

```{r}
m_icc100_varOcup <- matrix(,nrow = length(var_desmpleo), ncol = 3)
for(i in 1:length(var_desmpleo)){
  m_icc100_varOcup[i,1] <- samplesize4surveys::ICC(dplyr::filter(consulta_ocupac, URBRUR == 1)[[var_desmpleo[i]]], 
                                        cl = dplyr::filter(consulta_ocupac, URBRUR == 1)$id_upm100)$ICC
}

for(i in 1:length(var_desmpleo)){
  m_icc100_varOcup[i,2] <- samplesize4surveys::ICC(dplyr::filter(consulta_ocupac, URBRUR == 2)[[var_desmpleo[i]]], cl = dplyr::filter(consulta_ocupac, URBRUR == 2)$id_upm100)$ICC
}


for(i in 1:length(var_desmpleo)){
  m_icc100_varOcup[i,3] <- samplesize4surveys::ICC(consulta_ocupac[[var_desmpleo[i]]], 
                                        cl = consulta_ocupac$id_upm100)$ICC
}

colnames(m_icc100_varOcup) <- c("Urbano", "Rural", "Nacional")
row.names(m_icc100_varOcup) <- var_desmpleo
```




```{r}
m_icc_varOcup <- round(m_icc_varOcup, 2)
m_icc50_varOcup <- round(m_icc50_varOcup, 2)
m_icc100_varOcup <- round(m_icc100_varOcup, 2)
```




```{r}
df_ICC_varOcup <- bind_rows(as.data.frame(m_icc_varOcup) %>% 
                      tibble::rownames_to_column(), as.data.frame(m_icc50_varOcup) %>% 
tibble::rownames_to_column(),
as.data.frame(m_icc100_varOcup) %>% 
tibble::rownames_to_column()
                    )
names(df_ICC_varOcup)[1] <- "VariablesOcupacioneles"
df_ICC_varOcup$Escenario <- c(rep("Originales", 1),
                      rep("Uniones 50", 1),
                      rep("Uniones 100", 1)
                      )
df_ICC_varOcup <- arrange(df_ICC_varOcup, VariablesOcupacioneles)
```


```{r}
df_ICC_varOcup <- df_ICC_varOcup[c(1,3,2),]
```

```{r}
gc(reset = T)
```


# Tamaños

```{r}
df_tamoriginal_varOcup <- consulta_ocupac %>% group_by(id_upm_inicial) %>% summarise(num_hogares = n())

df_tamano50_varOcup <- consulta_ocupac %>% group_by(id_upm50) %>% summarise(num_hogares = n())

df_tamano100_varOcup <- consulta_ocupac %>% group_by(id_upm100) %>% summarise(num_hogares = n())

summary(df_tamoriginal_varOcup$num_hogares)
summary(df_tamano50_varOcup$num_hogares)
summary(df_tamano100_varOcup$num_hogares)
```

```{r}
gc(reset = T)
```

Guardar las correlaciones intraclásicas:

```{r}
setwd("../output/5.CorrelacionesIntraclasicasCenso")
library(glue)

saveRDS(consulta_ocupac, "consulta_ocupac.rds")
saveRDS(df_ICC_varOcup, "df_ICC_varOcup.rds")
```





# NBI

Calculamos la correlación intraclasíca para las variables del NBI:

```{r}
setwd("../output/4.UPM_Colapsadas_indicadores")
df_nbi <- readRDS("viviendasNBI.rds")
```

Las variables a analizar son:
  
```{r}
var_nbi <-  c("CARENCIA_CALIDADVIVIENDA", "HACINAMIENTO", "CARENCIA_ABASTECAGUA", 
"CARENCIA_SERVSANITARIO", "CARENCIA_INSUMOSENERGETICOS", "CARENCIA_ASISESCOLAR", 
"CARENCIA_SALUD", "CARENCIA_PRECARIEDADOCUPACIONAL", "NBI")
```

# Escenario original

```{r}

m_icc_nbi <- matrix(,nrow = length(var_nbi), ncol = 3)
for(i in 1:length(var_nbi)){
  m_icc_nbi[i,1] <- samplesize4surveys::ICC(dplyr::filter(df_nbi, URBRUR == 1)[[var_nbi[i]]], 
                                            cl = dplyr::filter(df_nbi, URBRUR == 1)$id_upm_inicial)$ICC
}

for(i in 1:length(var_nbi)){
  m_icc_nbi[i,2] <- samplesize4surveys::ICC(dplyr::filter(df_nbi, URBRUR == 2)[[var_nbi[i]]], cl = dplyr::filter(df_nbi, URBRUR == 2)$id_upm_inicial)$ICC
}


for(i in 1:length(var_nbi)){
  m_icc_nbi[i,3] <- samplesize4surveys::ICC(df_nbi[[var_nbi[i]]], 
                                            cl = df_nbi$id_upm_inicial)$ICC
}

colnames(m_icc_nbi) <- c("Urbano", "Rural", "Nacional")
row.names(m_icc_nbi) <- var_nbi


# df_deff_nbi <- 1 + (as.matrix(m_icc_nbi) * (10 - 1))

```


# Escenario con 50 viviendas


```{r}
m_icc_nbi50 <- matrix(,nrow = length(var_nbi), ncol = 3)
for(i in 1:length(var_nbi)){
  m_icc_nbi50[i,1] <- samplesize4surveys::ICC(dplyr::filter(df_nbi, URBRUR == 1)[[var_nbi[i]]], 
                                               cl = dplyr::filter(df_nbi, URBRUR == 1)$id_upm50 )$ICC
}

for(i in 1:length(var_nbi)){
  m_icc_nbi50[i,2] <- samplesize4surveys::ICC(dplyr::filter(df_nbi, URBRUR == 2)[[var_nbi[i]]], cl = dplyr::filter(df_nbi, URBRUR == 2)$id_upm50 )$ICC
}


for(i in 1:length(var_nbi)){
  m_icc_nbi50[i,3] <- samplesize4surveys::ICC(df_nbi[[var_nbi[i]]], 
                                               cl = df_nbi$id_upm50 )$ICC
}

colnames(m_icc_nbi50) <- c("Urbano", "Rural", "Nacional")
row.names(m_icc_nbi50) <- var_nbi


# df_deff_nbi50 <- 1 + (as.matrix(m_icc_nbi50) * (10 - 1))

```



# Escenario con 100


```{r}
m_icc_nbi100 <- matrix(,nrow = length(var_nbi), ncol = 3)
for(i in 1:length(var_nbi)){
  m_icc_nbi100[i,1] <- samplesize4surveys::ICC(dplyr::filter(df_nbi, URBRUR == 1)[[var_nbi[i]]], 
                                               cl = dplyr::filter(df_nbi, URBRUR == 1)$id_upm100 )$ICC
}

for(i in 1:length(var_nbi)){
  m_icc_nbi100[i,2] <- samplesize4surveys::ICC(dplyr::filter(df_nbi, URBRUR == 2)[[var_nbi[i]]], cl = dplyr::filter(df_nbi, URBRUR == 2)$id_upm100 )$ICC
}


for(i in 1:length(var_nbi)){
  m_icc_nbi100[i,3] <- samplesize4surveys::ICC(df_nbi[[var_nbi[i]]], 
                                               cl = df_nbi$id_upm100 )$ICC
}

colnames(m_icc_nbi100) <- c("Urbano", "Rural", "Nacional")
row.names(m_icc_nbi100) <- var_nbi


#df_deff_nbi100 <- 1 + (as.matrix(m_icc_nbi100) * (10 - 1))
```



```{r}
m_icc_nbi <- round(m_icc_nbi, 2)
m_icc_nbi50 <- round(m_icc_nbi50, 2)
m_icc_nbi100 <- round(m_icc_nbi100, 2)

```

```{r}
df_ICC <- bind_rows(as.data.frame(m_icc_nbi) %>% 
                      tibble::rownames_to_column(), as.data.frame(m_icc_nbi50) %>% 
                      tibble::rownames_to_column(),
                    as.data.frame(m_icc_nbi100) %>% 
                      tibble::rownames_to_column()
)
names(df_ICC)[1] <- "Carencias"
df_ICC$Escenario <- c(rep("Originales", 9),
                      rep("Uniones 50", 9),
                      rep("Uniones 100", 9)
)
df_ICC <- arrange(df_ICC, Carencias, Escenario )
```

```{r}
names(df_ICC)[1] <- "Carencias"
df_ICC <- arrange(df_ICC, Carencias)
```   

```{r}
df_ICC <- df_ICC[c(1,3,2,4,6,5,  7, 9, 8,  10, 12, 11,  
                   13, 15, 14,  16, 18, 17, 
                   19, 21, 20,   22, 24, 23,  25, 27, 26),]
```

# Tamaños

```{r}
df_tamoriginal <- df_nbi %>% group_by(id_upm_inicial) %>% summarise(num_hogares = n())

df_tamano50 <- df_nbi %>% group_by(id_upm50) %>% summarise(num_hogares = n())

df_tamano100 <- df_nbi %>% group_by(id_upm100) %>% summarise(num_hogares = n())

summary(df_tamoriginal$num_hogares) 
summary(df_tamano50$num_hogares)
summary(df_tamano100$num_hogares)

```

Guardar 
```{r}
setwd("../output/5.CorrelacionesIntraclasicasCenso")
saveRDS(df_ICC, "df_ICC.rds")
saveRDS(df_nbi, "df_nbi.rds")
```

# Comportamiento de los indicadores



```{r}
library(sjPlot)
p1 <- plot_grpfrq(df_nbi$URBRUR , 
                  df_nbi$CARENCIA_CALIDADVIVIENDA, drop.empty = FALSE, show.prc = T, show.grpcnt  = T, bar.pos = "stack")

library(ggplot2)
p1 <- ggplot(df_nbi, aes(x=as.factor(URBRUR), fill=as.factor(CARENCIA_CALIDADVIVIENDA)))+
  geom_bar(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..]), position="dodge" ) +
  geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),
            stat="count", position=position_dodge(0.9), vjust=-0.5) +
  scale_y_continuous(labels = scales::percent)


p2 <- ggplot(df_nbi, aes(x=as.factor(URBRUR), fill=as.factor(HACINAMIENTO)))+
  geom_bar(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..]), position="dodge" ) +
  geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),
            stat="count", position=position_dodge(0.9), vjust=-0.5) +
  scale_y_continuous(labels = scales::percent)



p3 <- ggplot(df_nbi, aes(x=as.factor(URBRUR), fill=as.factor(CARENCIA_ABASTECAGUA)))+
  geom_bar(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..]), position="dodge" ) +
  geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),
            stat="count", position=position_dodge(0.9), vjust=-0.5) +
  scale_y_continuous(labels = scales::percent)





p4 <- ggplot(df_nbi, aes(x=as.factor(URBRUR), fill=as.factor(CARENCIA_SERVSANITARIO)))+
  geom_bar(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..]), position="dodge" ) +
  geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),
            stat="count", position=position_dodge(0.9), vjust=-0.5) +
  scale_y_continuous(labels = scales::percent)


p5 <- ggplot(df_nbi, aes(x=as.factor(URBRUR), fill=as.factor(CARENCIA_INSUMOSENERGETICOS)))+
  geom_bar(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..]), position="dodge" ) +
  geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),
            stat="count", position=position_dodge(0.9), vjust=-0.5) +
  scale_y_continuous(labels = scales::percent)


p6 <- ggplot(df_nbi, aes(x=as.factor(URBRUR), fill=as.factor(CARENCIA_ASISESCOLAR)))+
  geom_bar(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..]), position="dodge" ) +
  geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),
            stat="count", position=position_dodge(0.9), vjust=-0.5) +
  scale_y_continuous(labels = scales::percent)

p7 <- ggplot(df_nbi, aes(x=as.factor(URBRUR), fill=as.factor(CARENCIA_SALUD)))+
  geom_bar(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..]), position="dodge" ) +
  geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),
            stat="count", position=position_dodge(0.9), vjust=-0.5) +
  scale_y_continuous(labels = scales::percent)


p8 <- ggplot(df_nbi, aes(x=as.factor(URBRUR), fill=as.factor(CARENCIA_PRECARIEDADOCUPACIONAL)))+
  geom_bar(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..]), position="dodge" ) +
  geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),
            stat="count", position=position_dodge(0.9), vjust=-0.5) +
  scale_y_continuous(labels = scales::percent)



p9 <- ggplot(df_nbi, aes(x=as.factor(URBRUR), fill=as.factor(NBI)))+
  geom_bar(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..]), position="dodge" ) +
  geom_text(aes( y=..count../tapply(..count.., ..x.. ,sum)[..x..], label=scales::percent(..count../tapply(..count.., ..x.. ,sum)[..x..]) ),
            stat="count", position=position_dodge(0.9), vjust=-0.5) +
  scale_y_continuous(labels = scales::percent)


library(patchwork)
grafico_carencias1 <- (p1 + p2) / (p3 + p4) 
grafico_carencias2 <- (p5 + p6) / (p7 + p8) 

```

```{r}
p9
```


```

